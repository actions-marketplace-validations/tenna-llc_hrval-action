apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
aliases:
  tenna/image_tag: &image_tag "v1.20.0-build.35.cognito"
  tenna/rw_env: &rw_env
    - name: NODE_ENV
      value: "production"
metadata:
  name: be-crud-v4
  namespace: be-crud
  annotations:
    # flux.weave.works/ignore: "true"
    # fluxcd.io/automated: "true"
spec:
  helmVersion: v3
  maxHistory: 20
  releaseName: be-crud-v4
  chart:
    repository: http://helm.cloud.tenna.com
    name: api-special-routing
    version: 1.0.5
  values:
    name: be-crud-v4
    environment: dv3
    migration:
      serviceAccountName: default-becrud-account
      enabled: true
      activeDeadlineSeconds: 600
      image:
        repository: ghcr.io/tenna-llc/be-crud
        tag: *image_tag
      command: ["npm", "run", "migrate:sequelize"]
      env: *rw_env
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 250m
          memory: 256Mi
    service:
      serviceAccountName: default-becrud-account
      livenessProbe:
        httpGet:
          path: /api/v4/info/health
          port: 3000
        failureThreshold: 3
        periodSeconds: 10
      startupProbe:
        httpGet:
          path: /api/v4/info/health
          port: 3000
        failureThreshold: 10
        periodSeconds: 10
      containerPort: 3000
      image:
        repository: ghcr.io/tenna-llc/be-crud
        tag: *image_tag
      resources:
        limits:
          cpu: 1000m
          memory: 1500Mi
        requests:
          cpu: 1000m
          memory: 900Mi
      hpa:
        minReplicas: 2
        metrics:
          - type: Resource
            resource:
              name: cpu
              targetAverageUtilization: 70
      crudDeploymentEnv: *rw_env
      getDeploymentEnv: *ro_env
    istio:
      public:
        enabled: true
        rewrite:
          enabled: true
          path: /api/v4/
        prefixName: /v4
        cors:
          enabled: true
          allowOrigins:
            - prefix: https://dv3.nonprod.tenna.com/
          allowHeaders:
            - "Authorization"
            - "ImpersonateToken"
            - "Content-Type"
            - "Content-Length"
            - "Content-Encoding"
            - "User-Agent"
            - "Referer"
            - "Accept*"
